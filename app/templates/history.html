{% extends "base.html" %}
{% block content %}
<h2>Validation History</h2>

<input type="text" id="searchBox" placeholder="Search email..." onkeyup="applyFilters()">
<button onclick="exportCSV()">Export CSV</button>

{% if validations %}
    <table id="historyTable" border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Email ⬍</th>
                <th onclick="sortTable(1)">Status ⬍</th>
            </tr>
        </thead>
        <tbody>
        {% for v in validations %}
        <tr>
            <td>{{ v.email }}</td>
            <td>{{ v.status }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div id="pagination" style="margin-top:10px;"></div>
{% else %}
    <p>No validations found.</p>
{% endif %}

<script>
const rowsPerPage = 50;
let currentPage = 1;
let currentSortCol = null;
let sortAsc = true;

function applyFilters() {
    filterTable();
    paginate();
}

function filterTable() {
    let input = document.getElementById("searchBox").value.toLowerCase();
    let rows = document.querySelectorAll("#historyTable tbody tr");

    rows.forEach(row => {
        let email = row.cells[0].textContent.toLowerCase();
        row.style.display = email.includes(input) ? "" : "none";
    });
}

function sortTable(columnIndex) {
    let table = document.getElementById("historyTable");
    let rows = Array.from(table.querySelectorAll("tbody tr")).filter(r => r.style.display !== "none");

    if (currentSortCol === columnIndex) {
        sortAsc = !sortAsc;
    } else {
        sortAsc = true;
    }
    currentSortCol = columnIndex;

    rows.sort((a, b) => {
        let valA = a.cells[columnIndex].innerText.toLowerCase();
        let valB = b.cells[columnIndex].innerText.toLowerCase();
        if (valA < valB) return sortAsc ? -1 : 1;
        if (valA > valB) return sortAsc ? 1 : -1;
        return 0;
    });

    let tbody = table.tBodies[0];
    rows.forEach(r => tbody.appendChild(r));

    paginate();
}

function paginate() {
    let rows = document.querySelectorAll("#historyTable tbody tr");
    let visibleRows = Array.from(rows).filter(row => row.style.display !== "none");
    let pagination = document.getElementById("pagination");

    let totalPages = Math.ceil(visibleRows.length / rowsPerPage);
    if (currentPage > totalPages) currentPage = 1;

    visibleRows.forEach(r => r.style.display = "none");

    let start = (currentPage - 1) * rowsPerPage;
    let end = start + rowsPerPage;
    visibleRows.slice(start, end).forEach(r => r.style.display = "");

    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
        let btn = document.createElement("button");
        btn.innerText = i;
        btn.style.margin = "2px";
        btn.onclick = () => { currentPage = i; paginate(); };
        if (i === currentPage) {
            btn.style.fontWeight = "bold";
        }
        pagination.appendChild(btn);
    }
}

function exportCSV() {
    let rows = document.querySelectorAll("#historyTable tbody tr");
    let visibleRows = Array.from(rows).filter(row => row.style.display !== "none");

    let csv = "Email,Status\n";
    visibleRows.forEach(row => {
        let email = row.cells[0].innerText;
        let status = row.cells[1].innerText;
        csv += `"${email}","${status}"\n`;
    });

    let blob = new Blob([csv], { type: "text/csv" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "validation_history.csv";
    a.click();
    URL.revokeObjectURL(url);
}

window.onload = () => {
    applyFilters();
};
</script>
{% endblock %}
