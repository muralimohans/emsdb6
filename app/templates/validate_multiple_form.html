{% extends "base.html" %}
{% block title %}Multiple Email Validation{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">Multiple Email Validation</h2>

    <form id="multipleForm" class="bg-white p-6 rounded-lg shadow-md space-y-4">
        <textarea name="emails" rows="6" required
                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter one email per line"></textarea>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
            Validate Emails
        </button>
    </form>

    <!-- Progress Bar -->
    <div id="progressContainer" class="mt-6 hidden">
        <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="progressBar" class="bg-green-600 h-4 rounded-full" style="width:0%"></div>
        </div>
        <p id="progressText" class="mt-2 text-sm text-gray-700">0%</p>
    </div>

    <!-- Results -->
    <div id="resultsContainer" class="mt-6 space-y-4"></div>
</div>

<script>
const form = document.getElementById("multipleForm");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const resultsContainer = document.getElementById("resultsContainer");

form.addEventListener("submit", (e) => {
    e.preventDefault();

    progressContainer.classList.remove("hidden");
    progressBar.style.width = "0%";
    progressText.textContent = "0%";
    resultsContainer.innerHTML = "";

    const emails = form.querySelector("textarea[name='emails']").value;

    const ws = new WebSocket(`ws://${window.location.host}/ws/validate/multiple`);

    ws.onopen = () => {
        ws.send(JSON.stringify({ emails, user_id: 1 }));
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.done) {
            progressText.textContent = "Completed!";
            ws.close();
            return;
        }

        const res = data.result;

        // Update progress
        progressBar.style.width = data.progress + "%";
        progressText.textContent = data.progress + "%";

        // Append result card
        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded shadow border";
        div.innerHTML = `
            <p><strong>Email:</strong> ${res.email}</p>
            <p><strong>Score:</strong> ${res.score} / 100</p>
            <p><strong>Status:</strong> ${res.status}</p>
            <details class="mt-2">
                <summary class="cursor-pointer font-semibold">Detailed Checks</summary>
                <table class="w-full mt-2 border-t text-left">
                    ${Object.keys(res.details).map(key => `
                        <tr class="border-t">
                            <td class="px-2 py-1">${key.replace('_',' ').toUpperCase()}</td>
                            <td class="px-2 py-1">${res.details[key] === true ? '<span class="text-green-500">&#10004;</span>' :
                                res.details[key] === false ? '<span class="text-red-500">&#10008;</span>' : '-'}</td>
                        </tr>
                    `).join('')}
                </table>
            </details>
        `;
        resultsContainer.appendChild(div);
    };

    ws.onerror = () => {
        progressText.textContent = "WebSocket error!";
    };
});
</script>
{% endblock %}
